(dp1
S'output'
p2
S''
sS'layer'
p3
S'/opt/web2py/applications/cmdb/controllers/process_instances.py'
p4
sS'code'
p5
S'import MySQLdb\nimport time\nimport re\ndef index():  \n   print("process_instances.index")\n   if(len(request.args) == 1):\n      instances = dbload(request.args(0))\n   else:\n      instances = dbload()\n   return dict(instances=instances)\n   \ndef edit():\n   """\n   Edit a particular app instance\n   """\n   print("instances.edit")\n   if(len(request.args) == 1 & request.args(0).isdigit()):\n      # User has selected an instance to edit. Show the form.\n      print("args = " + request.args[0])\n      process_completed = False\n      # Check form for processing. If good, update data in DB. If bad, forward back to form.\n      \n      instance = db_load_instance(request.args[0])\n      service_options = [OPTION(service.name, _value=service.id) for service in db().select(db.processes.id, db.processes.name)]\n      server_options = [OPTION(server.name, _value=server.id) for server in db().select(db.servers.id, db.servers.name)]\n      customer_options = [OPTION(customer.name, _value=customer.id) for customer in db().select(db.customers.id, db.customers.name)]\n      db_options = [OPTION(database.name, _value=database.id) for database in db().select(db.dbs.id, db.dbs.name)]\n      print("loading instance")\n      this_instance = db_load_instance(request.args(0))\n      print("---------------------------------------")\n      #print(this_instance.servers.name)\n      print("active = " + str(this_instance.process_instances.active))\n      print("---------------------------------------")\n      print("instance loaded")\n      form = FORM(TABLE(\n                        TR(TH(H2(\'Modify \' + this_instance.processes.name + " @ " + this_instance.servers.name), _colspan=3, _align=\'center\')),\n                        TR(\'Customer \', SELECT(customer_options, value=this_instance.customers.id, _name="customer_id")),\n                        TR(\'Service \', SELECT(service_options, value=this_instance.processes.id, _name="service_id")),\n                        TR(\'Server \', SELECT(server_options, value=this_instance.servers.id, _name="server_id")),\n                        TR(\'JMX Port \', INPUT(_type="text", _name="port_jmx", value=this_instance.process_instances.jmx_port, requires=IS_INT_IN_RANGE(2000,100000))),\n                        TR(\'HTTP Port \', INPUT(_type="text", _name="port_http", value=this_instance.process_instances.http_port, requires=IS_INT_IN_RANGE(2000,100000))),\n                        TR(\'DB \', SELECT(db_options, value=this_instance.dbs.id, _name="dbs_id")),\n                        TR(\'Active \', (\'YES \', INPUT(_type="radio", _name="active", _value=\'True\', value=str(this_instance.process_instances.active)), \' NO \', INPUT(_type="radio", _name="active", _value=\'False\', value=str(this_instance.process_instances.active)))),\n                        TR("",(INPUT(_type="submit", _value="Submit"), " ", INPUT(_type="button", _value="Cancel", _onclick="parent.location=\'" + URL(r=request, f=\'index\') + "\'")))\n                        #TR(TH(H2(\'Modify \' + this_instance.processes.name), _colspan=3, _align=\'center\')),\n                       )\n                 )\n      \n      if(request.vars):\n         print "Processing update."\n         curtime = MySQLdb.TimestampFromTicks(time.time())\n         service_id = request.vars.service_id\n         customer_id = request.vars.customer_id\n         server_id = request.vars.server_id\n         db_id = request.vars.db_id\n         isactive = request.vars.active\n         port_jmx = request.vars.port_jmx\n         port_http = request.vars.port_http\n         all_digits = "^(\\d+)$"\n         \n         if(customer_id == "SELECT"):\n            response.flash = "Please select a Customer"  \n            return dict(form=form)\n         elif(service_id == "SELECT"):\n            response.flash = "Please select a Service"\n            return dict(form=form)\n         elif(server_id == "SELECT"):\n            response.flash = "Please select a Server"\n            return dict(form=form)\n         elif port_jmx and not re.search(all_digits, port_jmx):\n            response.flash = "JMX Port must be a number or empty."\n            return dict(form=form)\n         elif port_http and not re.search(all_digits, port_http):\n            response.flash = "HTTP Port must be a number or empty."\n            return dict(form=form)\n         else:\n            # PROCESS FORM & INSERT INTO DB\n            print("Process Form")\n            curtime = MySQLdb.TimestampFromTicks(time.time())\n            db(db.process_instances.id == this_instance.process_instances.id).update(processes_id = service_id, servers_id = server_id, customers_id = customer_id, jmx_port = port_jmx, http_port = port_http, active = isactive, updated_at = curtime)\n            print("--------------")\n            print(db._lastsql)\n            print("--------------")\n            print("Service Instance successfully inserted into DB")\n            redirect(URL(r=request, f=\'index\'))\n            return(dict())\n         \n         \n         \n      if(not process_completed):\n         return dict(form=form)\n   else:\n      redirect(URL(r=request,f=\'index\'))\n   \n   \ndef add():\n   print("instances.add")\n   \n   service_options = [OPTION("SELECT", _value="SELECT")] + [OPTION(service.name, _value=service.id) for service in db().select(db.processes.id, db.processes.name)]\n   server_options = [OPTION("SELECT", _value="SELECT")] + [OPTION(server.name, _value=server.id) for server in db().select(db.servers.id, db.servers.name)]\n   customer_options = [OPTION("SELECT", _value="SELECT")] + [OPTION(customer.name, _value=customer.id) for customer in db().select(db.customers.id, db.customers.name)]\n   db_options = [OPTION("NONE", _value="NONE")] + [OPTION(database.name, _value=database.id) for database in db().select(db.dbs.id, db.dbs.name)]\n   \n   if(request.vars):\n      curtime = MySQLdb.TimestampFromTicks(time.time())\n      service_id = request.vars.service_id\n      customer_id = request.vars.customer_id\n      server_id = request.vars.server_id\n      db_id = request.vars.db_id\n      isactive = request.vars.active\n      port_jmx = request.vars.port_jmx\n      port_http = request.vars.port_http\n      form = FORM(TABLE(\n                     TR(TH(H2(\'Create Instance\'), _colspan=3, _align=\'center\')),\n                     TR(\'Customer \', SELECT(customer_options, value=customer_id, _name="customer_id")),\n                     TR(\'Service \', SELECT(service_options, value=service_id, _name="service_id")),\n                     TR(\'Server \', SELECT(server_options, value=server_id, _name="server_id")),\n                     TR(\'JMX Port \', INPUT(_type="text", _name="port_jmx", requires=IS_INT_IN_RANGE(2000,100000))),\n                     TR(\'HTTP Port \', INPUT(_type="text", _name="port_http", requires=IS_INT_IN_RANGE(2000,100000))),\n                     TR(\'DB \', SELECT(db_options, value=db_id, _name="db_id")),\n                     TR(\'Active \', (\'YES \', INPUT(_type="radio", _name="active", _value=\'True\', value=isactive), \' NO \', INPUT(_type="radio", _name="active", _value=\'False\', value=isactive))),\n                     TR("",(INPUT(_type="submit", _value="Submit"), " ", INPUT(_type="button", _value="Cancel", _onclick="parent.location=\'" + URL(r=request, f=\'index\') + "\'")))\n                     #TR(TH(H2(\'Modify \' + this_instance.processes.name), _colspan=3, _align=\'center\')),\n                    )\n              )\n      all_digits = "^\\d+$"\n      if(customer_id == "SELECT"):\n         response.flash = "Please select a Customer"  \n         return dict(form=form)\n      elif(service_id == "SELECT"):\n         response.flash = "Please select a Service"\n         return dict(form=form)\n      elif(server_id == "SELECT"):\n         response.flash = "Please select a Server"\n         return dict(form=form)\n      elif port_jmx and not re.search(all_digits, port_jmx):\n         response.flash = "JMX Port must be a number or empty."\n         return dict(form=form)\n      elif port_http and not re.search(all_digits, port_http):\n         response.flash = "HTTP Port must be a number or empty."\n         return dict(form=form)\n      else:\n         # PROCESS FORM & INSERT INTO DB\n         print("Process Form")\n         curtime = MySQLdb.TimestampFromTicks(time.time())\n         db.process_instances.insert(processes_id = service_id,\n                                     servers_id = server_id,\n                                     customers_id = customer_id,\n                                     active = isactive,\n                                     created_at = curtime,\n                                     updated_at = curtime)\n         print("--------------")\n         print(db._lastsql)\n         print("--------------")\n         print("Service Instance successfully inserted into DB")\n         redirect(URL(r=request, f=\'index\'))\n         return(dict())\n   else:\n      form = FORM(TABLE(\n                     TR(TH(H2(\'Create Instance\'), _colspan=3, _align=\'center\')),\n                     TR(\'Customer \', SELECT(customer_options, _name="customer_id")),\n                     TR(\'Service \', SELECT(service_options, _name="service_id")),\n                     TR(\'Server \', SELECT(server_options, _name="server_id")),\n                     TR(\'JMX Port \', INPUT(_type="text", _name="port_jmx")),\n                     TR(\'HTTP Port \', INPUT(_type="text", _name="port_http")),\n                     TR(\'DB \', SELECT(db_options, _name="db_id")),\n                     TR(\'Active \', (\'YES \', INPUT(_type="radio", _name="active", _value=\'True\', value=\'True\'), \' NO \', INPUT(_type="radio", _name="active", _value=\'False\', value=\'True\'))),\n                     TR("",(INPUT(_type="submit", _value="Submit"), " ", INPUT(_type="button", _value="Cancel", _onclick="parent.location=\'" + URL(r=request, f=\'index\') + "\'")))\n                     #TR(TH(H2(\'Modify \' + this_instance.processes.name), _colspan=3, _align=\'center\')),\n                    )\n              )\n      return dict(form=form)\n   \n   \ndef db_load_instance(app_instance_id):\n   print("db_load_instance(" + app_instance_id + ")")\n   instances = db(\n                    (db.app_instances.id == app_instance_id)\n                  & (db.process_instances.servers_id == db.servers.id)\n                  & (db.processes.id == db.process_instances.processes_id)\n                  & (db.process_instances.customers_id == db.customers.id)\n                  & (db.groups.id == db.processes.groups_id)\n                  & ((db.process_instances.id == db.db_2_process_instances.process_instances_id) & (db.dbs.id == db.db_2_process_instances.dbs_id))\n                  & ((db.app_instances.apps_id == db.apps.id) & (db.app_instances.process_instances_id == db.process_instances.id))\n                 ).select(\n                           db.app_instances.id,\n                           db.process_instances.id,\n                           db.process_instances.http_port,\n                           db.process_instances.jmx_port,\n                           db.process_instances.active,\n                           db.servers.id,\n                           db.servers.name, \n                           db.customers.id,\n                           db.customers.name,\n                           db.processes.id,\n                           db.processes.name, \n                           db.dbs.id,\n                           db.dbs.name,\n                           db.groups.id,\n                           db.groups.name,\n                           groupby=db.apps.id\n                         )\n   print("--------------")\n   print(db._lastsql)\n   print("--------------")\n   return instances[0]\n   \n   \n   \n   \ndef dbload(sort_by="customer"):\n   """\n   OLD QUERY:\n   SELECT \n   app_instances.id, \n   process_instances.id, process_instances.http_port, process_instances.jmx_port, process_instances.active, \n   servers.id, servers.name, \n   customers.id, customers.name, \n   processes.id, processes.name, \n   dbs.id, dbs.name, \n   groups.id, groups.name \n   FROM customers, apps, servers, db_2_process_instances, groups, processes, app_instances, dbs, process_instances \n   WHERE (((((process_instances.servers_id=servers.id AND processes.id=process_instances.processes_id) \n   AND process_instances.customers_id=customers.id) AND groups.id=processes.groups_id) \n   AND (process_instances.id=db_2_process_instances.process_instances_id AND dbs.id=db_2_process_instances.dbs_id)) \n   AND (app_instances.apps_id=apps.id AND app_instances.process_instances_id=process_instances.id)) \n   GROUP BY apps.id ORDER BY customers.name;\n\n   NEW QUERY:\n   select \n   processes.id AS SERVICE_ID, processes.name AS SERVICE_NAME,\n   customers.id AS C_ID, customers.name AS C_NAME, \n   servers.id AS SERVER_ID, servers.name as SERVER_NAME,\n   groups.name, \n   process_instances.id AS SI_ID, process_instances.http_port, process_instances.jmx_port, process_instances.active, \n   db_2_process_instances.id AS D2SI_ID,\n   dbs.name AS DB_NAME\n   from servers, groups, processes, customers, process_instances process_instances\n   LEFT OUTER JOIN     db_2_process_instances\n   ON             process_instances.id = db_2_process_instances.process_instances_id\n   LEFT OUTER JOIN     dbs\n   ON             dbs.id = db_2_process_instances.dbs_id\n   where processes.id = process_instances.processes_id\n   and servers.id = process_instances.servers_id\n   and customers.id = process_instances.customers_id\n   and groups.id = processes.groups_id\n   """\n   print("instances.dbload")\n   if cmp(sort_by, "customer") == 0:\n      order_by = db.customers.name\n   elif cmp(sort_by, "group") == 0:\n      order_by = db.groups.name\n   elif cmp(sort_by, "service") == 0:\n      order_by = db.processes.name\n   elif cmp(sort_by, "jmx_port") == 0:\n      order_by = db.process_instances.jmx_port\n   elif cmp(sort_by, "server") == 0:\n      order_by = db.servers.name\n   elif cmp(sort_by, "db") == 0:\n      order_by = db.dbs.name\n   #rs = db(\n   #              (db.processes.id == db.process_instances.processes_id)\n   #              #& (db.process_instances.servers_id == 46) \n   #              & (db.customers.id == db.process_instances.customers_id)\n   #              ).select(\n   #                        db.processes.ALL, db.customers.ALL, db.dbs.ALL, db.process_instances.ALL, db.db_2_process_instances.ALL,\n   #                        left=[db.db_2_process_instances.on(db.process_instances.id == db.db_2_process_instances.process_instances_id),\n   #                              db.dbs.on(db.dbs.id == db.db_2_process_instances.dbs_id)\n   #                        ],\n   #                        #left=[db.process_instances.on(db.process_instances.id == db.db_2_process_instances.process_instances_id),\n   #                        #      db.dbs.on(db.dbs.id == db.db_2_process_instances.dbs_id)\n   #                        #],\n   #                        orderby=order_by\n   #                        )\n   rs = db(\n            (db.process_instances.processes_id == db.processes.id)\n            &\n            (db.process_instances.customers_id == db.customers.id)\n            &\n            (db.apps.processes_id == db.processes.id)\n            &\n            (db.app_instances.apps_id == db.apps.id)\n            &\n            (db.process_instances.servers_id == db.servers.id)\n            &\n            (db.processes_groups_id == db.groups.id)\n          ).select(\n                     db.processes.ALL, db.process_instances.ALL, db.customers.ALL, db.apps.ALL, db.app_instances.ALL, db.groups.ALL, db.servers.ALL,                     \n                     orderby = order_by\n                   )\n   print("--------------")\n   print(db._lastsql)\n   print("--------------")\n          \n       \n          \n   # The above query was erroring out when I tried to load the group & server with everything else. Thus, load it independently.\n   #for row in rs:\n   #   row.groups = db(db.groups.id == row.processes.groups_id).select()[0]\n   #   row.servers = db(db.servers.id == row.process_instances.servers_id).select()[0]\n   return rs\nresponse._vars=response._caller(index)\n'
p6
sS'traceback'
p7
S'Traceback (most recent call last):\n  File "/opt/web2py/gluon/restricted.py", line 173, in restricted\n    exec ccode in environment\n  File "/opt/web2py/applications/cmdb/controllers/process_instances.py", line 302, in <module>\n  File "/opt/web2py/gluon/globals.py", line 96, in <lambda>\n    self._caller = lambda f: f()\n  File "/opt/web2py/applications/cmdb/controllers/process_instances.py", line 9, in index\n    instances = dbload()\n  File "/opt/web2py/applications/cmdb/controllers/process_instances.py", line 286, in dbload\n    (db.processes_groups_id == db.groups.id)\n  File "/opt/web2py/gluon/sql.py", line 1295, in __getattr__\n    return dict.__getitem__(self,key)\nKeyError: \'processes_groups_id\'\n'
p8
s.